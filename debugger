#!/bin/bash

# Configuration
read -p "Enter the target IP to ping: " TARGET_IP
read -p "Enter the command to run on the remote device: " SSH_COMMAND
read -p "Enter the number of consecutive ping failures before SSH: " FAIL_THRESHOLD


# Initialize counters
fail_count=0

# Function to perform SSH and collect output
collect_output() {
    sshpass -p "Jaskirat2512+" ssh root@172.16.1.101 -t cli "$SSH_COMMAND" > /logs_junos/log.txt
}

# Infinite loop to constantly ping
while true; do
    # Ping the target IP
    ping -c 1 $TARGET_IP > /dev/null 2>&1

    if [ $? -ne 0 ]; then
        # Ping failed
        ((fail_count++))
        echo "Ping to $TARGET_IP failed ($fail_count/$FAIL_THRESHOLD)"

        if [ $fail_count -ge $FAIL_THRESHOLD ]; then
            echo "Ping failed $FAIL_THRESHOLD times, collecting output..."
            collect_output
            # Reset fail count after collecting output
            fail_count=0
        fi
    else
        # Ping succeeded, reset fail count
        fail_count=0
        echo "Ping to $TARGET_IP succeeded."
    fi

    # Wait for a while before the next ping
    sleep 5
done
